(* autogenerated from github.com/mjschwenne/grackle/testdata/out/go/event_gk *)
From Perennial.goose_lang Require Import prelude.
From Goose Require github_com.mjschwenne.grackle.testdata.out.go.timestamp_gk.
From Goose Require github_com.tchajed.marshal.

Section code.
Context `{ext_ty: ext_types}.

Definition S := struct.decl [
  "Id" :: uint32T;
  "Name" :: stringT;
  "StartTime" :: struct.t timestamp_gk.S;
  "EndTime" :: struct.t timestamp_gk.S
].

Definition Marshal: val :=
  rec: "Marshal" "e" "prefix" :=
    let: "enc" := ref_to (slice.T byteT) "prefix" in
    "enc" <-[slice.T byteT] (marshal.WriteInt32 (![slice.T byteT] "enc") (struct.get S "Id" "e"));;
    let: "nameBytes" := StringToBytes (struct.get S "Name" "e") in
    "enc" <-[slice.T byteT] (marshal.WriteInt (![slice.T byteT] "enc") (slice.len "nameBytes"));;
    "enc" <-[slice.T byteT] (marshal.WriteBytes (![slice.T byteT] "enc") "nameBytes");;
    "enc" <-[slice.T byteT] (timestamp_gk.Marshal (struct.get S "StartTime" "e") (![slice.T byteT] "enc"));;
    "enc" <-[slice.T byteT] (timestamp_gk.Marshal (struct.get S "EndTime" "e") (![slice.T byteT] "enc"));;
    ![slice.T byteT] "enc".

Definition Unmarshal: val :=
  rec: "Unmarshal" "s" :=
    let: "enc" := ref_to (slice.T byteT) "s" in
    let: "id" := ref (zero_val uint32T) in
    let: "name" := ref (zero_val stringT) in
    let: "startTime" := ref (zero_val (struct.t timestamp_gk.S)) in
    let: "endTime" := ref (zero_val (struct.t timestamp_gk.S)) in
    let: ("0_ret", "1_ret") := marshal.ReadInt32 (![slice.T byteT] "enc") in
    "id" <-[uint32T] "0_ret";;
    "enc" <-[slice.T byteT] "1_ret";;
    let: "nameLen" := ref (zero_val uint64T) in
    let: "nameBytes" := ref (zero_val (slice.T byteT)) in
    let: ("0_ret", "1_ret") := marshal.ReadInt (![slice.T byteT] "enc") in
    "nameLen" <-[uint64T] "0_ret";;
    "enc" <-[slice.T byteT] "1_ret";;
    let: ("0_ret", "1_ret") := marshal.ReadBytesCopy (![slice.T byteT] "enc") (![uint64T] "nameLen") in
    "nameBytes" <-[slice.T byteT] "0_ret";;
    "enc" <-[slice.T byteT] "1_ret";;
    "name" <-[stringT] (StringFromBytes (![slice.T byteT] "nameBytes"));;
    let: ("0_ret", "1_ret") := timestamp_gk.Unmarshal (![slice.T byteT] "enc") in
    "startTime" <-[struct.t timestamp_gk.S] "0_ret";;
    "enc" <-[slice.T byteT] "1_ret";;
    let: ("0_ret", "1_ret") := timestamp_gk.Unmarshal (![slice.T byteT] "enc") in
    "endTime" <-[struct.t timestamp_gk.S] "0_ret";;
    "enc" <-[slice.T byteT] "1_ret";;
    (struct.mk S [
       "Id" ::= ![uint32T] "id";
       "Name" ::= ![stringT] "name";
       "StartTime" ::= ![struct.t timestamp_gk.S] "startTime";
       "EndTime" ::= ![struct.t timestamp_gk.S] "endTime"
     ], ![slice.T byteT] "enc").

End code.
